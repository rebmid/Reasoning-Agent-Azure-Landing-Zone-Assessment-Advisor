{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://lz-assessor/schemas/control_definition.schema.json",
  "title": "Control Definition",
  "description": "Authoritative control definition for lz-assessor. alz_design_area is the single taxonomy key — all other classifications (platform_domain, waf_pillar, scoring_section) derive from it.",
  "type": "object",
  "required": [
    "control_id",
    "name",
    "alz_design_area",
    "severity",
    "evaluation_mode",
    "version"
  ],
  "properties": {
    "control_id": {
      "type": "string",
      "description": "Stable hierarchical ID. Pattern: {area_prefix}{sequence}.{sub}. Once assigned, never changes.",
      "pattern": "^[A-Z]{1,3}[0-9]{2}\\.[0-9]{2}$",
      "examples": ["N01.02", "S03.14", "G05.01", "I02.03", "M01.01", "C01.02"]
    },
    "legacy_id": {
      "type": "string",
      "description": "Previous 8-char short ID or full GUID for migration linkage. Retained for backward compatibility with existing runs."
    },
    "name": {
      "type": "string",
      "description": "Human-readable control name for reports",
      "minLength": 5,
      "maxLength": 200
    },
    "description": {
      "type": "string",
      "description": "Detailed control description for AI context and report tooltips"
    },
    "alz_design_area": {
      "type": "string",
      "description": "THE authoritative ALZ taxonomy field. Everything else derives from this.",
      "enum": [
        "network_topology_and_connectivity",
        "identity_and_access_management",
        "governance",
        "management",
        "security",
        "data_protection",
        "resilience",
        "cost",
        "resource_organization",
        "platform_automation_and_devops",
        "azure_billing_and_entra_tenant"
      ]
    },
    "alz_sub_area": {
      "type": "string",
      "description": "Optional refinement within the design area (e.g., 'Hub-Spoke Topology', 'PIM Configuration'). Controlled vocabulary per design_area — not free-text.",
      "maxLength": 100
    },
    "waf_pillar_overrides": {
      "type": "array",
      "description": "Secondary WAF pillars beyond the default derived from alz_design_area. Empty or omitted = default only.",
      "items": {
        "type": "string",
        "enum": [
          "Reliability",
          "Security",
          "Cost Optimization",
          "Operational Excellence",
          "Performance Efficiency"
        ]
      },
      "maxItems": 4,
      "uniqueItems": true
    },
    "severity": {
      "type": "string",
      "enum": ["Critical", "High", "Medium", "Low"],
      "description": "Risk severity — determines scoring weight via SEVERITY_WEIGHT lookup"
    },
    "evaluation_mode": {
      "type": "string",
      "enum": ["data_driven", "questionnaire", "hybrid"],
      "description": "How this control is evaluated: data_driven (automated signals only), questionnaire (manual input only), hybrid (both)"
    },
    "evidence_sources": {
      "type": "array",
      "description": "Signal sources consumed by the evaluator. Required for data_driven and hybrid modes.",
      "items": {
        "$ref": "#/$defs/evidence_source"
      }
    },
    "question_template": {
      "type": "object",
      "description": "Question definition for questionnaire and hybrid modes",
      "properties": {
        "text": {
          "type": "string",
          "description": "Question presented to the assessor"
        },
        "type": {
          "type": "string",
          "enum": ["yes_no", "maturity_scale", "multi_select", "free_text"],
          "description": "Answer input type"
        },
        "scoring_map": {
          "type": "object",
          "description": "Maps answer values → status outcomes",
          "additionalProperties": {
            "type": "string",
            "enum": ["Pass", "Fail", "Partial"]
          }
        },
        "options": {
          "type": "array",
          "description": "Available choices for multi_select type",
          "items": { "type": "string" }
        }
      },
      "required": ["text", "type"]
    },
    "evaluator_module": {
      "type": "string",
      "description": "Python module path containing the evaluator function (e.g., 'evaluators.networking')"
    },
    "depends_on": {
      "type": "array",
      "description": "Control IDs that must pass before this control can be evaluated. Uses control_id (not legacy_id).",
      "items": { "type": "string" },
      "uniqueItems": true
    },
    "defer_if_parent_fails": {
      "type": "boolean",
      "default": false,
      "description": "If true, skip evaluation when any depends_on control fails — status becomes Deferred"
    },
    "rationale_template": {
      "type": "object",
      "description": "Templates for generating human-readable rationale text. Supports placeholders: {evidence_count}, {coverage_pct}, {subscription_count}",
      "properties": {
        "pass":    { "type": "string" },
        "fail":    { "type": "string" },
        "partial": { "type": "string" },
        "manual":  { "type": "string" }
      },
      "additionalProperties": false
    },
    "caf_guidance": {
      "type": "string",
      "description": "Short Cloud Adoption Framework / ALZ guidance text"
    },
    "caf_url": {
      "type": "string",
      "format": "uri",
      "description": "Link to official CAF/ALZ documentation page"
    },
    "version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+$",
      "description": "Control definition version (e.g., '1.0'). Increment minor for logic changes, major for breaking changes."
    },
    "tags": {
      "type": "array",
      "description": "Free-form tags for filtering and grouping (e.g., ['defender', 'baseline', 'zero-trust'])",
      "items": { "type": "string", "maxLength": 50 },
      "uniqueItems": true
    }
  },
  "$defs": {
    "evidence_source": {
      "type": "object",
      "description": "A signal source consumed by the evaluator for this control",
      "required": ["signal_bus_name", "signal_category"],
      "properties": {
        "signal_bus_name": {
          "type": "string",
          "description": "Signal bus key matching signals.json (e.g., 'resource_graph:azure_firewall', 'defender:pricings')"
        },
        "signal_category": {
          "type": "string",
          "enum": [
            "resource_graph",
            "arm",
            "policy",
            "defender",
            "monitor",
            "identity",
            "cost",
            "network",
            "manage"
          ],
          "description": "Provider category for telemetry classification and preflight probe mapping"
        },
        "description": {
          "type": "string",
          "description": "What this signal provides for this control's evaluation"
        }
      },
      "additionalProperties": false
    }
  },
  "allOf": [
    {
      "if": {
        "properties": { "evaluation_mode": { "const": "data_driven" } }
      },
      "then": {
        "required": ["evidence_sources", "evaluator_module"],
        "properties": {
          "evidence_sources": { "minItems": 1 }
        }
      }
    },
    {
      "if": {
        "properties": { "evaluation_mode": { "const": "questionnaire" } }
      },
      "then": {
        "required": ["question_template"]
      }
    },
    {
      "if": {
        "properties": { "evaluation_mode": { "const": "hybrid" } }
      },
      "then": {
        "required": ["evidence_sources", "question_template", "evaluator_module"],
        "properties": {
          "evidence_sources": { "minItems": 1 }
        }
      }
    }
  ],
  "additionalProperties": false
}
